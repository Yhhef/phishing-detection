# 每日工作记录

## Day 19 - 全面性能评估 (2026-01-01)

### 今日目标
- 实现ModelEvaluator性能评估类
- 生成混淆矩阵、ROC曲线、PR曲线可视化
- 创建评估报告生成功能
- 验证模型性能指标达标

### 完成内容

#### 1. ModelEvaluator类实现 (model_training.py)

**核心方法**:
| 方法 | 功能 |
|------|------|
| evaluate_model() | 评估单个模型，计算全部指标 |
| plot_confusion_matrix() | 绘制混淆矩阵（支持归一化） |
| plot_roc_curve() | 绘制ROC曲线（多模型对比） |
| plot_pr_curve() | 绘制PR曲线（多模型对比） |
| plot_all_curves() | 绘制综合评估图（3合1） |
| plot_metrics_comparison() | 绘制指标对比柱状图 |
| generate_report() | 生成评估报告文本 |
| get_detailed_metrics() | 获取详细指标DataFrame |
| compare_models() | 按指标排序比较模型 |
| save_results() | 保存评估结果为JSON |
| load_results() | 加载评估结果 |

**评估指标（8项）**:
- 准确率 (Accuracy)
- 精确率 (Precision)
- 召回率 (Recall)
- F1分数 (F1-Score)
- 特异度 (Specificity)
- MCC (Matthews相关系数)
- AUC-ROC
- AUC-PR

#### 2. 便捷函数实现

| 函数 | 功能 |
|------|------|
| evaluate_all_models() | 批量评估多个模型并生成图表 |
| generate_final_report() | 生成最终评估报告（含图表和JSON） |

#### 3. 性能评估结果

**三模型对比**:
| 模型 | 准确率 | 精确率 | 召回率 | F1 | AUC-ROC | AUC-PR |
|------|--------|--------|--------|-----|---------|--------|
| RandomForest | 99.64% | 100.00% | 99.25% | 99.62% | 99.96% | 99.96% |
| XGBoost | **99.79%** | 99.70% | **99.85%** | **99.77%** | **99.99%** | **99.99%** |
| Ensemble | 99.79% | **99.85%** | 99.70% | 99.77% | 99.97% | 99.97% |

**性能目标验证**:
| 指标 | 结果 | 目标 | 状态 |
|------|------|------|------|
| 准确率 | 99.79% | ≥90% | ✅ PASS |
| 精确率 | 99.70% | ≥88% | ✅ PASS |
| 召回率 | 99.85% | ≥85% | ✅ PASS |
| AUC-ROC | 99.99% | ≥95% | ✅ PASS |

**混淆矩阵（XGBoost - 最佳模型）**:
```
              预测合法  预测钓鱼
实际合法       732       2
实际钓鱼         1     663
```
- TP=663, TN=732, FP=2, FN=1
- 总错误仅3个！

#### 4. 生成的评估文件

**图表文件** (data/evaluation/figures/):
| 文件 | 说明 |
|------|------|
| roc_curves.png | ROC曲线对比图 |
| pr_curves.png | PR曲线对比图 |
| metrics_comparison.png | 指标柱状对比图 |
| *_confusion_matrix.png | 各模型混淆矩阵 |
| *_confusion_matrix_normalized.png | 归一化混淆矩阵 |
| *_evaluation.png | 各模型综合评估图 |

**报告文件** (data/evaluation/reports/):
| 文件 | 说明 |
|------|------|
| evaluation_report.txt | 完整评估报告 |
| evaluation_results.json | 评估结果JSON |
| evaluation_metrics.csv | 指标表格CSV |

#### 5. 单元测试

新增测试类:
- TestModelEvaluator: 22个测试用例
- TestEvaluationConvenienceFunctions: 3个测试用例
- TestModelEvaluatorIntegration: 2个测试用例

运行结果: **27个测试全部通过**

### 文件变更

| 文件 | 变更 |
|------|------|
| src/model_training.py | 新增ModelEvaluator类(~700行) |
| tests/test_model_training.py | 新增27个测试用例 |
| scripts/day19_evaluation.py | 新增验证脚本 |
| data/evaluation/ | 新增评估报告和图表目录 |

### Day 19 验收

```
[x] ModelEvaluator类实现
[x] evaluate_model方法
[x] plot_confusion_matrix方法
[x] plot_roc_curve方法
[x] plot_pr_curve方法
[x] plot_all_curves方法
[x] plot_metrics_comparison方法
[x] generate_report方法
[x] save_results/load_results方法
[x] evaluate_all_models便捷函数
[x] generate_final_report便捷函数
[x] 单元测试: 27个全部通过
[x] 性能指标达标

[SUCCESS] Day 19 任务全部完成!
```

### 下一步计划

**Day 20 - 模型优化与阈值调整**
- 实现阈值调整功能
- 分析不同阈值对精确率/召回率的影响
- 选择最佳模型参数组合
- 完成阶段三模型训练总结

---

## Day 13-14 - 30维特征完善 + DNS修复 + 模型重训练 (2025-12-31)

### 今日目标
- 修复DNS特征提取失败问题
- 完成完整30维特征提取
- 重新训练RF+XGBoost集成模型

### 完成内容

#### 1. DNS特征修复
**问题**: DNS特征全部为-1，缺失dnspython库
**解决**: `pip install dnspython`

运行 `scripts/fix_dns_features.py` 补充DNS特征：
- 处理记录: 6989条
- DNS解析成功: 6719条 (96.1%)
- DNS解析失败: 270条 (3.9%)

#### 2. 30维特征提取完成

**最终特征完成度**:
| 特征类别 | 维度 | 成功率 | 说明 |
|----------|------|--------|------|
| URL词法特征 | 17/17 | 100% | 本地计算，无需网络 |
| HTTP响应特征 | 5/5 | 100% | status_code, response_time等 |
| SSL证书特征 | 5/5 | 98.9% | valid, days_remaining等 |
| DNS特征 | 3/3 | 96.1% | resolve_time, record_count, has_mx |
| **总计** | **30/30** | **100%** | 全部特征均可用 |

**数据文件**:
| 文件 | 记录数 | 说明 |
|------|--------|------|
| 30dim_results.csv | 6989 | 完整30维特征 |
| train_30dim.csv | 5591 | 训练集(80%) |
| test_30dim.csv | 1398 | 测试集(20%) |

#### 3. 模型重新训练

运行 `scripts/train_30dim_model.py`：

**模型性能对比**:
| 模型 | 准确率 | 精确率 | 召回率 | F1 |
|------|--------|--------|--------|-----|
| RandomForest | 99.64% | 99.57% | 99.71% | 99.64% |
| XGBoost | 99.86% | 99.71% | 100.00% | 99.86% |
| **Ensemble** | **99.79%** | 99.71% | 99.86% | 99.79% |

**特征重要性 Top 10** (RandomForest):
| 排名 | 特征 | 重要性 |
|------|------|--------|
| 1 | num_slashes | 21.06% |
| 2 | path_length | 19.95% |
| 3 | url_length | 11.75% |
| 4 | num_subdomains | 10.31% |
| 5 | num_dots | 7.22% |
| 6 | http_status_code | 5.31% |
| 7 | content_length | 4.61% |
| 8 | entropy | 3.85% |
| 9 | http_response_time | 2.88% |
| 10 | dns_resolve_time | 2.17% |

**发现**:
- 引入网络特征后，模型性能进一步提升
- HTTP状态码、内容长度进入Top10重要特征
- DNS解析时间也具有一定区分能力

#### 4. 模型文件

| 文件 | 大小 | 说明 |
|------|------|------|
| ensemble_30dim_model.pkl | 1534KB | RF+XGBoost集成 |
| rf_30dim_model.pkl | 637KB | RandomForest单独 |
| scaler_30dim.pkl | 2KB | 标准化器 |
| feature_columns_30dim.txt | 0.4KB | 特征列名 |

### Git提交记录
```
[Day 13-14][feat] 30维特征完善 + DNS修复 + 模型重训练

新增脚本:
- extract_30dim_features.py: 完整30维特征提取
- fix_dns_features.py: DNS特征补充提取
- train_30dim_model.py: 模型训练脚本
- verify_phase2.py: 阶段二验收脚本

数据成果:
- 6989条完整30维特征记录
- 模型准确率: 99.79% (集成)
```

### 阶段二特征工程总结
```
[OK] URL词法特征(17维): 100%完成
[OK] HTTP响应特征(5维): 100%完成
[OK] SSL证书特征(5维): 98.9%完成
[OK] DNS特征(3维): 96.1%完成

[SUCCESS] 阶段二特征工程全部完成！
         30维特征 × 6989条记录
         集成模型准确率: 99.79%
```

---

## Day 13 - 特征工程完成与阶段二验收 (2025-12-25)

### 今日目标
- 完成特征提取和预处理
- 通过阶段二验收

### 完成内容

#### 1. 特征提取方案调整
- **原计划**: 30维特征提取（17 URL词法 + 5 HTTP响应 + 5 SSL证书 + 3 DNS）
- **遇到问题**: Windows环境下网络特征提取（HTTP/SSL/DNS）出现socket超时，30维提取在467/8000条时卡住
- **解决方案**: 采用17维URL快速模式，仅提取URL词法特征，无需网络请求

#### 2. 17维URL特征提取完成
- 训练集: 8000条URL → `train_features.csv`
- 测试集: 2000条URL → `test_features.csv`
- 提取耗时: ~4秒

**17维特征列表**:
| 特征名 | 描述 |
|-------|------|
| url_length | URL总长度 |
| domain_length | 域名长度 |
| path_length | 路径长度 |
| num_dots | 点号数量 |
| num_hyphens | 连字符数量 |
| num_underscores | 下划线数量 |
| num_slashes | 斜杠数量 |
| num_digits | 数字数量 |
| has_ip | 是否包含IP地址 |
| has_at | 是否包含@符号 |
| num_subdomains | 子域名数量 |
| has_https | 是否使用HTTPS |
| path_depth | 路径深度 |
| has_port | 是否包含端口号 |
| entropy | URL熵值 |
| is_shortening | 是否短链接服务 |
| has_suspicious | 是否包含可疑词汇 |

#### 3. 特征预处理完成
- 缺失值处理: -1 → NaN → 中位数填充
- 异常值处理: 99百分位截断
- 标准化: StandardScaler
- 输出文件:
  - `train_scaled.csv` (8000条)
  - `test_scaled.csv` (2000条)
  - `scaler.pkl` (标准化器)

#### 4. 阶段二验收通过
验收结果:
```
[PASS] 代码文件
[PASS] 数据文件
[PASS] 测试文件
[PASS] Notebook文件
[PASS] 特征提取功能
[PASS] 预处理功能
[PASS] 数据质量
[PASS] 图表文件

[SUCCESS] 阶段二验收通过！
```

数据质量检查:
- NaN数量: 0
- Inf数量: 0
- 标签分布: {0: 4000, 1: 4000} (平衡)
- 特征均值范围: [-0.5420, 0.0952]
- 特征标准差范围: [0.3227, 1.0029]

### 数据文件清单
| 文件 | 记录数 | 说明 |
|------|--------|------|
| dataset.csv | 10000 | 原始合并数据 |
| train.csv | 8000 | 训练集URL |
| test.csv | 2000 | 测试集URL |
| train_features.csv | 8000 | 训练集特征(17维) |
| test_features.csv | 2000 | 测试集特征(17维) |
| train_scaled.csv | 8000 | 标准化训练集 |
| test_scaled.csv | 2000 | 标准化测试集 |
| scaler.pkl | - | StandardScaler模型 |

### 问题与解决
| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 30维提取卡住 | Windows socket超时 | 改用17维URL快速模式 |
| Multiprocessing pickle错误 | Windows无法序列化局部函数 | 避免使用multiprocessing |

### 技术说明
17维URL特征足以支持有效的钓鱼网站检测:
- 覆盖URL结构特征(长度、深度、特殊字符)
- 覆盖安全特征(HTTPS、IP地址、端口)
- 覆盖可疑模式(短链接、敏感词汇)
- 学术研究表明URL词法特征是钓鱼检测最重要的特征类别

### 下一步计划
**Day 15 - XGBoost分类器**
- 实现XGBoost分类器
- 对比RF和XGBoost性能
- 准备集成模型

---

## Day 14 - RandomForest分类器训练 (2025-12-31)

### 今日目标
- 实现RandomForest分类器训练
- 评估模型性能（目标：准确率≥85%）
- 保存训练好的模型

> **通俗版说明**: 详见 `docs/Day14-RandomForest实现流程说明.md`

### 完成内容

#### 1. 模型训练模块实现
创建 `src/model_training.py`，采用面向对象设计：

**类结构**:
| 类名 | 描述 |
|------|------|
| BaseModelTrainer | 抽象基类，定义模型训练通用接口 |
| RandomForestTrainer | RandomForest分类器实现 |
| XGBoostTrainer | XGBoost预留接口（Day 15实现）|
| EnsembleTrainer | 集成模型预留接口（Day 16实现）|

**核心方法**:
- `build_model()`: 构建模型
- `train()`: 训练模型
- `predict()`: 预测
- `predict_proba()`: 预测概率
- `evaluate()`: 评估模型
- `save_model()`: 保存模型
- `load_model()`: 加载模型
- `get_feature_importance()`: 获取特征重要性

#### 2. RandomForest模型参数
```python
RandomForestClassifier(
    n_estimators=100,      # 100棵决策树
    max_depth=10,          # 最大深度10
    min_samples_split=5,   # 分裂最小样本数
    min_samples_leaf=2,    # 叶节点最小样本数
    random_state=42,       # 随机种子
    n_jobs=-1              # 使用所有CPU核心
)
```

#### 3. 模型评估结果

**性能指标** (远超目标！):
| 指标 | 结果 | 目标 | 状态 |
|------|------|------|------|
| 准确率 (Accuracy) | **99.25%** | ≥85% | ✅ 超越14.25% |
| 精确率 (Precision) | **100.00%** | - | ✅ 完美 |
| 召回率 (Recall) | **98.50%** | - | ✅ 优秀 |
| F1分数 (F1-Score) | **99.24%** | - | ✅ 优秀 |
| AUC-ROC | **99.79%** | - | ✅ 接近完美 |

**混淆矩阵**:
```
              预测合法  预测钓鱼
实际合法       1000       0
实际钓鱼         15     985
```
- 真阳性(TP): 985 - 正确检测钓鱼网站
- 真阴性(TN): 1000 - 正确识别合法网站
- 假阳性(FP): 0 - 无误报！
- 假阴性(FN): 15 - 仅15个钓鱼网站漏检

#### 4. 特征重要性分析 (Top 10)

| 排名 | 特征 | 重要性 | 说明 |
|------|------|--------|------|
| 1 | num_slashes | 0.2514 | 斜杠数量最重要 |
| 2 | path_length | 0.2433 | 路径长度 |
| 3 | url_length | 0.1558 | URL总长度 |
| 4 | num_subdomains | 0.1205 | 子域名数量 |
| 5 | num_dots | 0.0916 | 点号数量 |
| 6 | entropy | 0.0449 | URL熵值 |
| 7 | num_digits | 0.0306 | 数字数量 |
| 8 | domain_length | 0.0295 | 域名长度 |
| 9 | num_hyphens | 0.0151 | 连字符数量 |
| 10 | path_depth | 0.0087 | 路径深度 |

**关键发现**:
- URL结构特征（斜杠、路径、长度）是最重要的检测指标
- 前5个特征贡献了86%的预测能力
- 17维URL词法特征已足够实现高精度检测

#### 5. 训练信息
- 训练集: 8000样本 × 17特征
- 测试集: 2000样本 × 17特征
- 训练耗时: **0.22秒**
- 模型文件: `data/models/rf_model.pkl`

### 文件清单
| 文件 | 说明 |
|------|------|
| src/model_training.py | 模型训练模块（477行） |
| tests/test_model_training.py | 单元测试文件（19个测试用例） |
| data/models/rf_model.pkl | 训练好的RandomForest模型 |

### 单元测试结果
运行 `pytest tests/test_model_training.py -v`：
```
19 passed in 2.23s
```
测试覆盖:
- TestRandomForestTrainer: 16个测试（构建、训练、预测、评估、保存/加载、异常处理）
- TestLoadFeatureData: 1个测试（数据加载）
- TestBaseModelTrainer: 1个测试（抽象类验证）
- TestIntegration: 1个测试（真实数据集成测试）

### 技术亮点
1. **面向对象设计**: 使用ABC抽象基类，便于扩展XGBoost和集成模型
2. **元数据保存**: 模型文件包含训练时间、参数、特征名等信息
3. **完整评估**: 包含准确率、精确率、召回率、F1、AUC-ROC、混淆矩阵
4. **特征重要性**: 可视化分析最重要的检测特征

### Day 14 验收
```
[PASS] 模型训练完成
[PASS] 准确率 99.25% >= 85% 目标
[PASS] 模型文件已保存
[PASS] 特征重要性分析完成
[PASS] 代码结构清晰，可扩展

[SUCCESS] Day 14 任务完成！
```

### 下一步计划
**Day 15 - XGBoost分类器**
- 完善XGBoostTrainer类实现
- 训练XGBoost模型
- 对比RF和XGBoost性能差异

---

## 阶段进度总览

| 阶段 | 天数 | 状态 | 说明 |
|------|------|------|------|
| 一 | Day 1-5 | ✅ 完成 | 环境搭建、数据采集 |
| 二 | Day 6-13 | ✅ 完成 | 特征工程 |
| 三 | Day 14-20 | 🔄 进行中 | 模型训练 |
| 四 | Day 21-28 | ⏳ 待开始 | Web开发 |
| 五 | Day 29-40 | ⏳ 待开始 | 论文撰写 |
